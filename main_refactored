import pygame
from config import *
from game_state import GameState
from game_logic import GameLogic
from renderer import Renderer
from ui import UI


class Jeu:
    """Classe principale du jeu"""
    
    def __init__(self):
        pygame.init()
        self.screen = pygame.display.set_mode((LARGEUR, HAUTEUR))
        pygame.display.set_caption("Survie jusqu'à l'aube")
        self.clock = pygame.time.Clock()
        self.running = True
        
        # Composants du jeu
        self.state = GameState()
        self.logic = GameLogic(self.state)
        self.renderer = Renderer(self.screen)
        self.ui = UI()
        
        # SYSTÈME DE QUÊTE ÉLECTRIQUE
        self.lumiere_eteinte = True  # Commence dans le noir
        self.panneaux_actives = 0  # 0/2 panneaux activés
        self.panneaux_electricite = self._creer_panneaux_electricite()
        
        # Ajouter message initial
        self.state.ajouter_message("Il fait noir ! Trouvez les 2 panneaux électriques pour rallumer la lumière !", 300)
    
    def _creer_panneaux_electricite(self):
        """Crée les 2 panneaux électriques à activer"""
        panneaux = []
        
        # Panneau 1 - Position fixe (ajustez selon votre carte)
        panneaux.append({
            'x': 150,
            'y': 400,
            'largeur': 40,
            'hauteur': 60,
            'actif': False,
            'nom': 'Panneau 1'
        })
        
        # Panneau 2 - Position fixe
        panneaux.append({
            'x': 1250,
            'y': 600,
            'largeur': 40,
            'hauteur': 60,
            'actif': False,
            'nom': 'Panneau 2'
        })
        
        return panneaux
    
    def gerer_evenements(self):
        """Gère tous les événements du jeu"""
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                self.running = False
            elif event.type == pygame.KEYDOWN:
                if event.key == pygame.K_e:
                    # D'abord vérifier les panneaux électriques
                    panneau_active = self._verifier_activation_panneau()
                    if not panneau_active:
                        # Si pas de panneau, gérer le ramassage normal
                        self.logic.gerer_evenement_ramassage()
    
    def _verifier_activation_panneau(self):
        """Vérifie si le joueur peut activer un panneau électrique"""
        joueur = self.state.joueur
        
        for panneau in self.panneaux_electricite:
            if panneau['actif']:
                continue  # Déjà activé
            
            # Calculer la distance
            dx = panneau['x'] - joueur.x
            dy = panneau['y'] - joueur.y
            distance = (dx**2 + dy**2)**0.5
            
            # Si proche du panneau
            if distance < 60:
                panneau['actif'] = True
                self.panneaux_actives += 1
                
                if self.panneaux_actives >= 2:
                    # Les 2 panneaux sont activés !
                    self.lumiere_eteinte = False
                    self.state.ajouter_message("Les lumières sont revenues ! Vous pouvez maintenant voir les monstres !", 200)
                else:
                    self.state.ajouter_message(f"Panneau activé ! ({self.panneaux_actives}/2)", 120)
                
                return True
        
        return False
    
    def mettre_a_jour(self):
        """Met à jour l'état du jeu"""
        # Entrées
        self.logic.gerer_entrees()
        
        # Monstres
        self.logic.mettre_a_jour_monstres()
        
        # Paranoïa
        self.logic.mettre_a_jour_paranoia()
        
        # Conditions de fin
        condition, raison = self.logic.verifier_conditions_fin()
        if condition == "game_over":
            self.game_over(raison)
        elif condition == "victoire":
            self.victoire()
        
        # Temps et caméra
        self.state.incrementer_temps()
        self.state.mettre_a_jour_messages()
        self.state.mettre_a_jour_camera()
    
    def dessiner(self):
        """Dessine tout le jeu"""
        # Appliquer l'effet d'obscurité si les lumières sont éteintes
        if self.lumiere_eteinte:
            # NOTE: Si dessiner_monde_obscur n'existe pas dans renderer.py, ajoutez:
            # - Fond noir au lieu de gris
            # - Murs très sombres (30, 30, 30) au lieu de clairs
            # - Objets visibles mais sombres
            # - Monstres invisibles OU avec une aura rouge si proches
            # 
            # Si la méthode n'existe pas, utilisez temporairement:
            # self.renderer.dessiner_monde(self.state)
            # et ajoutez manuellement une surface noire semi-transparente après
            
            try:
                self.renderer.dessiner_monde_obscur(self.state)
            except AttributeError:
                # Fallback si la méthode n'existe pas encore
                self.renderer.dessiner_monde(self.state)
                # Ajouter une couche d'obscurité
                obscurite = pygame.Surface((LARGEUR, HAUTEUR))
                obscurite.fill((0, 0, 0))
                obscurite.set_alpha(180)  # 0 = transparent, 255 = opaque
                self.screen.blit(obscurite, (0, 0))
        else:
            self.renderer.dessiner_monde(self.state)
        
        # Dessiner les panneaux électriques
        self._dessiner_panneaux_electricite()
        
        # Interface
        self.ui.dessiner_interface(
            self.screen,
            self.state.joueur,
            self.state.temps,
            self.state.quetes,
            self.state.quete_actuelle,
            self.state.messages
        )
        
        # Afficher le compteur de panneaux
        self._dessiner_compteur_panneaux()
        
        pygame.display.flip()
    
    def _dessiner_panneaux_electricite(self):
        """Dessine les panneaux électriques sur la carte"""
        camera_x = self.state.camera.x
        camera_y = self.state.camera.y
        joueur = self.state.joueur
        
        for panneau in self.panneaux_electricite:
            # Couleur selon l'état
            if panneau['actif']:
                couleur = (0, 255, 0)  # Vert si activé
            else:
                couleur = (100, 100, 100)  # Gris si inactif
            
            # Position à l'écran
            x_ecran = panneau['x'] - camera_x
            y_ecran = panneau['y'] - camera_y
            
            # Dessiner le panneau
            pygame.draw.rect(self.screen, couleur,
                           (x_ecran, y_ecran, panneau['largeur'], panneau['hauteur']))
            pygame.draw.rect(self.screen, (255, 255, 255),
                           (x_ecran, y_ecran, panneau['largeur'], panneau['hauteur']), 2)
            
            # LED indicateur
            led_couleur = (0, 255, 0) if panneau['actif'] else (255, 0, 0)
            pygame.draw.circle(self.screen, led_couleur,
                             (int(x_ecran + 20), int(y_ecran + 15)), 5)
            
            # Afficher "Appuyez sur E" si le joueur est proche et pas encore activé
            if not panneau['actif']:
                dx = panneau['x'] - joueur.x
                dy = panneau['y'] - joueur.y
                distance = (dx**2 + dy**2)**0.5
                
                if distance < 60:
                    font = pygame.font.Font(None, 24)
                    text = font.render("Appuyez sur E", True, (255, 255, 255))
                    text_rect = text.get_rect(center=(LARGEUR // 2, 50))
                    self.screen.blit(text, text_rect)
    
    def _dessiner_compteur_panneaux(self):
        """Affiche le compteur de panneaux activés"""
        font = pygame.font.Font(None, 28)
        couleur = (0, 255, 0) if self.panneaux_actives >= 2 else (255, 255, 0)
        text = font.render(f"Panneaux: {self.panneaux_actives}/2", True, couleur)
        self.screen.blit(text, (LARGEUR - 180, 10))
    
    def game_over(self, raison):
        """Gère la fin de partie (défaite)"""
        self.ui.afficher_game_over(self.screen, raison)
        self.running = False
    
    def victoire(self):
        """Gère la fin de partie (victoire)"""
        self.ui.afficher_victoire(self.screen)
        self.running = False
    
    def run(self):
        """Boucle principale du jeu"""
        while self.running:
            self.clock.tick(FPS)
            self.gerer_evenements()
            self.mettre_a_jour()
            self.dessiner()
        
        pygame.quit()


if __name__ == "__main__":
    jeu = Jeu()
    jeu.run()
